
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.google.com https://www.gstatic.com 'sha256-inline-allowed'; frame-src https://www.google.com; style-src 'self' 'unsafe-inline'; img-src 'self' https://img.icons8.com https://www.gstatic.com data:; connect-src 'self' https://keygenx-ce8h.onrender.com https://www.google.com; font-src 'self' data:;">
  <title>Painel de Administração - Among Us Keys</title>
  <script src="https://www.google.com/recaptcha/enterprise.js?onload=recaptchaEnterpriseLoaded&render=explicit" async defer></script>
  <style>
    :root {
      --bg: #0c0c0f;
      --text: #f0f4f8;
      --panel: #1e2a3e;
      --primary: #ffc107;
      --primary-dark: #d9a406;
      --secondary: #5bc0de;
      --danger: #dc3545;
      --success: #28a745;
      --error: #dc3545;
      --info: #17a2b8;
      --border: #3a506b;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --font-title: 'Orbitron', monospace;
      --font-body: 'Space Grotesk', sans-serif;
    }

    body.light {
      --bg: #f0f2f5;
      --text: #333;
      --panel: #fff;
      --border: #ccc;
      --shadow: 0 4px 24px rgba(0,0,0,0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-body), 'Segoe UI', Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: all 0.3s ease;
      background-image: radial-gradient(circle at 20% 50%, rgba(255, 193, 7, 0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(91, 192, 222, 0.05) 0%, transparent 50%);
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      background-color: var(--panel);
      padding: 30px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 2px solid var(--border);
      position: relative;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--primary);
    }

    .admin-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .admin-title h1 {
      font-family: var(--font-title);
      color: var(--primary);
      font-size: 2rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 10px rgba(255, 193, 7, 0.3);
    }

    .logo-admin {
      width: 48px;
      height: 48px;
      filter: drop-shadow(0 0 10px rgba(255, 193, 7, 0.5));
    }

    .theme-toggle {
      background: none;
      border: 2px solid var(--border);
      color: var(--text);
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: scale(1.05);
    }

    .security-status {
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
    }

    .session-timer {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.8rem;
      color: var(--primary);
    }

    .audit-log {
      background: rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .audit-entry {
      font-family: monospace;
      font-size: 0.8rem;
      padding: 2px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .rate-limit-warning {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid var(--danger);
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      color: var(--danger);
      display: none;
    }

    .section {
      background: rgba(0,0,0,0.1);
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 25px;
      border: 1px solid var(--border);
    }

    .section h2 {
      color: var(--secondary);
      font-family: var(--font-title);
      font-size: 1.4rem;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text);
    }

    input[type="text"], 
    input[type="number"], 
    input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 193, 7, 0.1);
    }

    input[readonly] {
      background: rgba(0,0,0,0.2);
      color: var(--text);
      font-family: monospace;
      opacity: 0.8;
    }

    .btn {
      background: var(--primary);
      color: #000;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
      text-decoration: none;
      font-family: var(--font-title);
    }

    .btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background: var(--secondary);
      color: #fff;
    }

    .btn.secondary:hover:not(:disabled) {
      background: #3a9bc8;
    }

    .btn.danger {
      background: var(--danger);
      color: #fff;
    }

    .btn.danger:hover:not(:disabled) {
      background: #c82333;
    }

    .btn.success {
      background: var(--success);
      color: #fff;
    }

    .btn.success:hover:not(:disabled) {
      background: #218838;
    }

    .status-display {
      background: rgba(0,0,0,0.2);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: monospace;
      font-size: 1.1rem;
    }

    .status-display.success {
      border-color: var(--success);
      color: var(--success);
      background: rgba(40, 167, 69, 0.1);
    }

    .status-display.error {
      border-color: var(--error);
      color: var(--error);
      background: rgba(220, 53, 69, 0.1);
    }

    .status-display.info {
      border-color: var(--info);
      color: var(--info);
      background: rgba(23, 162, 184, 0.1);
    }

    .keys-display {
      background: rgba(0,0,0,0.2);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .keys-section h3 {
      color: var(--primary);
      font-family: var(--font-title);
      margin-bottom: 15px;
      font-size: 1.2rem;
    }

    .key-list {
      list-style: none;
    }

    .key-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: monospace;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      position: relative;
    }

    .key-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--primary);
    }

    .key-text {
      filter: blur(4px);
      transition: filter 0.3s ease;
      cursor: pointer;
      user-select: none;
    }

    .key-text.revealed {
      filter: none;
      user-select: text;
    }

    .copy-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }

    .copy-btn:hover {
      background: rgba(255, 193, 7, 0.2);
      transform: scale(1.1);
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spin 0.75s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal {
      background: var(--panel);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 30px;
      max-width: 90vw;
      min-width: 400px;
      box-shadow: var(--shadow);
    }

    .modal h2 {
      color: var(--primary);
      font-family: var(--font-title);
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.5rem;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--panel);
      color: var(--text);
      border: 2px solid var(--border);
      border-left: 6px solid var(--primary);
      border-radius: 8px;
      padding: 16px 24px;
      box-shadow: var(--shadow);
      z-index: 9999;
      opacity: 0;
      transform: translateY(100px);
      transition: all 0.3s ease;
      max-width: 400px;
      font-weight: 600;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--error); }
    .toast.info { border-left-color: var(--info); }

    .confirm-modal .modal {
      text-align: center;
      min-width: 350px;
    }

    .confirm-modal p {
      margin-bottom: 25px;
      font-size: 1.1rem;
      line-height: 1.5;
    }

    .confirm-modal .btn-group {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .recaptcha-container {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }

      .admin-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .admin-title h1 {
        font-size: 1.5rem;
      }

      .modal {
        min-width: auto;
        margin: 20px;
      }

      .confirm-modal .btn-group {
        flex-direction: column;
      }

      .toast {
        right: 15px;
        left: 15px;
        bottom: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="loginModal" class="modal-overlay">
    <div class="modal">
      <h2>🔐 Acesso Admin - MIRA HQ</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="adminSecret">Senha de Administrador:</label>
          <input type="password" id="adminSecret" placeholder="Digite sua senha" required autocomplete="current-password" />
        </div>
        
        <div class="recaptcha-container">
          <div id="loginCaptcha"></div>
        </div>
        
        <div id="recaptchaError" class="status-display error" style="display: none;">
          ⚠️ Complete o reCAPTCHA antes de continuar
        </div>
        
        <button type="submit" class="btn" id="btnLogin">
          🚀 Acessar Painel
        </button>
        
        <div id="loginError" class="status-display error" style="display: none;"></div>
      </form>
    </div>
  </div>

  <!-- Main Admin Panel -->
  <div class="container">
    <div class="admin-header">
      <div class="admin-title">
        <img src="https://img.icons8.com/ios-filled/50/ffc107/lock-2.png" alt="Admin" class="logo-admin"/>
        <h1>Terminal Admin</h1>
      </div>
      <div style="display: flex; gap: 15px; align-items: center; flex-direction: column;">
        <div class="session-timer" id="sessionTimer">Sessão: --:--</div>
        <div style="display: flex; gap: 15px;">
          <button class="theme-toggle" id="themeToggle" title="Alternar tema">🌓</button>
          <button class="btn secondary" id="btnLogout" style="display: none;">
            🚪 Sair
          </button>
        </div>
      </div>
    </div>

    <!-- Security Status -->
    <div class="security-status" id="securityStatus">
      🛡️ Conexão Segura | Sessão Ativa | Logs Habilitados
    </div>

    <!-- Rate Limit Warning -->
    <div class="rate-limit-warning" id="rateLimitWarning">
      ⚠️ Muitas tentativas detectadas. Aguarde antes de tentar novamente.
    </div>

    <!-- Generate Keys Section -->
    <div class="section">
      <h2>⚡ Gerar Novas Chaves</h2>
      <div class="form-group">
        <label for="keyCount">Quantidade de Chaves (1-100):</label>
        <input type="number" id="keyCount" min="1" max="100" value="5" />
      </div>
      
      <div class="recaptcha-container">
        <div id="generateCaptcha"></div>
      </div>
      
      <button class="btn" id="btnGenerate" disabled>
        🔑 Gerar Chaves
      </button>
    </div>

    <!-- View Keys Section -->
    <div class="section">
      <h2>👁️ Visualizar Chaves</h2>
      <button class="btn secondary" id="btnViewKeys" disabled>
        📊 Atualizar Lista
      </button>
      
      <div class="keys-display" id="keysDisplay">
        <div class="status-display info">
          🔍 Clique em "Atualizar Lista" para carregar as chaves
        </div>
      </div>
    </div>

    <!-- Delete Keys Section -->
    <div class="section">
      <h2>🗑️ Gerenciar Chaves</h2>
      
      <div class="form-group">
        <label for="deleteKey">Excluir Chave Específica:</label>
        <input type="text" id="deleteKey" placeholder="Ex: 1234-5678-ABCD-EFGH" />
      </div>
      
      <div class="recaptcha-container">
        <div id="deleteCaptcha"></div>
      </div>
      
      <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <button class="btn secondary" id="btnDeleteKey" disabled>
          🗑️ Excluir Chave
        </button>
        <button class="btn danger" id="btnDeleteAll" disabled>
          💥 Excluir Todas
        </button>
      </div>
    </div>

    <!-- Audit Log Section -->
    <div class="section">
      <h2>📋 Log de Auditoria</h2>
      <div class="audit-log" id="auditLog">
        <div class="audit-entry">Sistema iniciado - aguardando login</div>
      </div>
    </div>

    <!-- Status Display -->
    <div class="status-display" id="statusDisplay">
      ⏳ Aguardando ação do administrador...
    </div>

    <div class="footer">
      © <span id="currentYear"></span> Among Us Admin Panel | Terminal MIRA HQ | v2.1 Secure
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal-overlay confirm-modal" style="display: none;">
    <div class="modal">
      <p id="confirmMessage"></p>
      <div class="btn-group">
        <button class="btn danger" id="confirmYes">✅ Confirmar</button>
        <button class="btn secondary" id="confirmNo">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const BACKEND_URL = "https://keygenx-ce8h.onrender.com";
    const RECAPTCHA_SITE_KEY = "6Lf2VD4rAAAAAKVTYfYhKeVfaCA9W0HToPSfmB50";
    const SESSION_TIMEOUT = 15 * 60 * 1000; // 15 minutes
    const RATE_LIMIT_DELAY = 3000; // 3 seconds between requests

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const adminSecretInput = document.getElementById('adminSecret');
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');
    const recaptchaError = document.getElementById('recaptchaError');
    const btnLogout = document.getElementById('btnLogout');
    const themeToggle = document.getElementById('themeToggle');
    const sessionTimer = document.getElementById('sessionTimer');
    const securityStatus = document.getElementById('securityStatus');
    const rateLimitWarning = document.getElementById('rateLimitWarning');
    const auditLog = document.getElementById('auditLog');
    
    const keyCountInput = document.getElementById('keyCount');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnViewKeys = document.getElementById('btnViewKeys');
    const deleteKeyInput = document.getElementById('deleteKey');
    const btnDeleteKey = document.getElementById('btnDeleteKey');
    const btnDeleteAll = document.getElementById('btnDeleteAll');
    
    const statusDisplay = document.getElementById('statusDisplay');
    const keysDisplay = document.getElementById('keysDisplay');
    const toast = document.getElementById('toast');
    const confirmModal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    const currentYear = document.getElementById('currentYear');

    // Security State
    let adminSecret = '';
    let loginCaptchaToken = null;
    let generateCaptchaToken = null;
    let deleteCaptchaToken = null;
    let recaptchaWidgets = {};
    let currentConfirmCallback = null;
    let toastTimeout = null;
    let sessionStartTime = null;
    let sessionTimeout = null;
    let lastRequestTime = 0;
    let requestCount = 0;
    let auditEntries = [];

    // Security Functions
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function validateInput(input, type = 'text') {
      if (!input || typeof input !== 'string') return false;
      
      switch (type) {
        case 'key':
          return /^[A-Z0-9\-]{4,50}$/.test(input.trim());
        case 'number':
          const num = parseInt(input, 10);
          return !isNaN(num) && num >= 1 && num <= 100;
        case 'password':
          return input.length >= 8 && input.length <= 128;
        default:
          return input.trim().length > 0 && input.length <= 1000;
      }
    }

    function checkRateLimit() {
      const now = Date.now();
      if (now - lastRequestTime < RATE_LIMIT_DELAY) {
        requestCount++;
        if (requestCount > 5) {
          showRateLimitWarning();
          return false;
        }
      } else {
        requestCount = 0;
      }
      lastRequestTime = now;
      return true;
    }

    function showRateLimitWarning() {
      rateLimitWarning.style.display = 'block';
      setTimeout(() => {
        rateLimitWarning.style.display = 'none';
      }, 5000);
    }

    function addAuditEntry(action, details = '') {
      const timestamp = new Date().toLocaleString('pt-BR');
      const entry = `[${timestamp}] ${action} ${details}`;
      auditEntries.unshift(entry);
      
      // Keep only last 50 entries
      if (auditEntries.length > 50) {
        auditEntries = auditEntries.slice(0, 50);
      }
      
      updateAuditLog();
    }

    function updateAuditLog() {
      auditLog.innerHTML = auditEntries
        .map(entry => `<div class="audit-entry">${sanitizeInput(entry)}</div>`)
        .join('');
    }

    function startSessionTimer() {
      sessionStartTime = Date.now();
      
      if (sessionTimeout) {
        clearInterval(sessionTimeout);
      }
      
      sessionTimeout = setInterval(() => {
        const elapsed = Date.now() - sessionStartTime;
        const remaining = SESSION_TIMEOUT - elapsed;
        
        if (remaining <= 0) {
          addAuditEntry('SECURITY', 'Sessão expirada automaticamente');
          showToast('Sessão expirada por segurança', 'error');
          handleLogout();
          return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        sessionTimer.textContent = `Sessão: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Warning at 2 minutes
        if (remaining <= 120000 && remaining > 119000) {
          showToast('Sessão expira em 2 minutos', 'info');
        }
      }, 1000);
    }

    function stopSessionTimer() {
      if (sessionTimeout) {
        clearInterval(sessionTimeout);
        sessionTimeout = null;
      }
      sessionTimer.textContent = 'Sessão: --:--';
    }

    function updateSecurityStatus() {
      const isHttps = window.location.protocol === 'https:';
      const hasSession = !!adminSecret;
      const hasLogs = auditEntries.length > 0;
      
      let status = '';
      if (isHttps) status += '🛡️ Conexão Segura | ';
      else status += '⚠️ Conexão Insegura | ';
      
      if (hasSession) status += 'Sessão Ativa | ';
      else status += 'Sem Sessão | ';
      
      if (hasLogs) status += 'Logs Habilitados';
      else status += 'Logs Desabilitados';
      
      securityStatus.textContent = status;
    }

    // Enhanced utility functions
    function setLoading(button, isLoading) {
      if (isLoading) {
        button.disabled = true;
        if (!button.querySelector('.spinner')) {
          const spinner = document.createElement('span');
          spinner.className = 'spinner';
          button.appendChild(spinner);
        }
      } else {
        button.disabled = false;
        const spinner = button.querySelector('.spinner');
        if (spinner) spinner.remove();
      }
    }

    function showStatus(message, type = 'info') {
      statusDisplay.textContent = sanitizeInput(message);
      statusDisplay.className = `status-display ${type}`;
    }

    function showToast(message, type = 'info') {
      if (toastTimeout) clearTimeout(toastTimeout);
      
      toast.textContent = sanitizeInput(message);
      toast.className = `toast show ${type}`;
      
      toastTimeout = setTimeout(() => {
        toast.className = 'toast';
      }, 4000);
    }

    function showConfirm(message, callback) {
      confirmMessage.textContent = message;
      currentConfirmCallback = callback;
      confirmModal.style.display = 'flex';
      confirmYes.focus();
    }

    function hideConfirm() {
      confirmModal.style.display = 'none';
      currentConfirmCallback = null;
    }

    // Theme Management
    function toggleTheme() {
      document.body.classList.toggle('light');
      const isLight = document.body.classList.contains('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
      themeToggle.textContent = isLight ? '🌙' : '☀️';
      addAuditEntry('UI', `Tema alterado para ${isLight ? 'claro' : 'escuro'}`);
    }

    function applyTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light');
        themeToggle.textContent = '🌙';
      } else {
        themeToggle.textContent = '☀️';
      }
    }

    // Panel Management
    function setPanelEnabled(enabled) {
      [btnGenerate, btnViewKeys, btnDeleteKey, btnDeleteAll, keyCountInput, deleteKeyInput].forEach(el => {
        if (el) el.disabled = !enabled;
      });
      btnLogout.style.display = enabled ? 'inline-flex' : 'none';
    }

    // Enhanced API Functions
    async function makeRequest(endpoint, params = {}) {
      if (!checkRateLimit()) {
        throw new Error('Rate limit exceeded');
      }

      const url = new URL(`${BACKEND_URL}/${endpoint}`);
      Object.keys(params).forEach(key => {
        if (params[key] !== null && params[key] !== undefined) {
          url.searchParams.append(key, params[key]);
        }
      });

      addAuditEntry('API', `Requisição para ${endpoint}`);

      try {
        const response = await fetch(url, {
          method: 'GET',
          cache: 'no-store',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        });

        const data = await response.json();

        if (!response.ok) {
          addAuditEntry('ERROR', `HTTP ${response.status} em ${endpoint}`);
          throw new Error(data.message || `HTTP ${response.status}`);
        }

        addAuditEntry('SUCCESS', `${endpoint} executado com sucesso`);
        return data;
      } catch (error) {
        addAuditEntry('ERROR', `Falha na requisição: ${error.message}`);
        console.error('API Request failed:', error);
        throw error;
      }
    }

    // Enhanced Authentication
    async function handleLogin() {
      const password = adminSecretInput.value.trim();
      
      if (!validateInput(password, 'password')) {
        showLoginError('Senha deve ter entre 8 e 128 caracteres');
        addAuditEntry('LOGIN', 'Tentativa com senha inválida');
        return;
      }

      if (!loginCaptchaToken) {
        recaptchaError.style.display = 'block';
        addAuditEntry('LOGIN', 'Tentativa sem reCAPTCHA');
        return;
      }

      try {
        setLoading(btnLogin, true);
        hideLoginError();
        addAuditEntry('LOGIN', 'Tentativa de login iniciada');

        const result = await makeRequest('admin_view_keys', {
          secret: password,
          recaptcha: loginCaptchaToken
        });

        if (result.status === 'success') {
          adminSecret = password;
          loginModal.style.display = 'none';
          setPanelEnabled(true);
          startSessionTimer();
          updateSecurityStatus();
          showToast('Login realizado com sucesso!', 'success');
          showStatus('✅ Conectado como administrador');
          addAuditEntry('LOGIN', 'Login bem-sucedido');
          loadKeys();
        } else {
          showLoginError(result.message || 'Credenciais inválidas');
          resetLoginCaptcha();
          addAuditEntry('LOGIN', 'Login falhou - credenciais inválidas');
        }
      } catch (error) {
        showLoginError('Erro de conexão ou falha na verificação');
        resetLoginCaptcha();
        addAuditEntry('ERROR', `Erro no login: ${error.message}`);
      } finally {
        setLoading(btnLogin, false);
      }
    }

    function showLoginError(message) {
      loginError.textContent = sanitizeInput(message);
      loginError.style.display = 'block';
      recaptchaError.style.display = 'none';
    }

    function hideLoginError() {
      loginError.style.display = 'none';
      recaptchaError.style.display = 'none';
    }

    function resetLoginCaptcha() {
      if (recaptchaWidgets.login) {
        grecaptcha.enterprise.reset(recaptchaWidgets.login);
        loginCaptchaToken = null;
      }
    }

    function handleLogout() {
      adminSecret = '';
      setPanelEnabled(false);
      stopSessionTimer();
      loginModal.style.display = 'flex';
      adminSecretInput.value = '';
      hideLoginError();
      showStatus('⏳ Aguardando login...');
      keysDisplay.innerHTML = '<div class="status-display info">🔍 Faça login para visualizar as chaves</div>';
      resetLoginCaptcha();
      updateSecurityStatus();
      addAuditEntry('LOGOUT', 'Usuário desconectado');
      showToast('Logout realizado', 'info');
    }

    // Enhanced Key Management
    async function generateKeys() {
      const count = parseInt(keyCountInput.value);
      
      if (!validateInput(keyCountInput.value, 'number')) {
        showStatus('❌ Quantidade inválida (1-100)', 'error');
        addAuditEntry('ERROR', 'Tentativa de gerar chaves com quantidade inválida');
        return;
      }

      if (!generateCaptchaToken) {
        showStatus('❌ Complete o reCAPTCHA para gerar chaves', 'error');
        return;
      }

      try {
        setLoading(btnGenerate, true);
        showStatus('⏳ Gerando chaves...');
        addAuditEntry('ACTION', `Iniciando geração de ${count} chaves`);

        const result = await makeRequest('admin_generate_keys', {
          secret: adminSecret,
          count: count,
          recaptcha: generateCaptchaToken
        });

        if (result.status === 'success') {
          showStatus(`✅ ${result.keys.length} chave(s) gerada(s) com sucesso`, 'success');
          showToast(`${result.keys.length} chave(s) gerada(s)!`, 'success');
          addAuditEntry('SUCCESS', `${result.keys.length} chaves geradas`);
          loadKeys();

          // Reset captcha after successful operation
          if (recaptchaWidgets.generate) {
            grecaptcha.enterprise.reset(recaptchaWidgets.generate);
            generateCaptchaToken = null;
          }
        } else {
          showStatus(`❌ ${result.message || 'Erro ao gerar chaves'}`, 'error');
          addAuditEntry('ERROR', `Falha na geração: ${result.message}`);
        }
      } catch (error) {
        showStatus(`❌ Falha: ${error.message}`, 'error');
        addAuditEntry('ERROR', `Erro na geração: ${error.message}`);
      } finally {
        setLoading(btnGenerate, false);
      }
    }

    async function loadKeys() {
      try {
        setLoading(btnViewKeys, true);
        showStatus('⏳ Carregando chaves...');
        keysDisplay.innerHTML = '<div class="status-display info">⏳ Carregando...</div>';
        addAuditEntry('ACTION', 'Carregando lista de chaves');

        const result = await makeRequest('admin_view_keys', {
          secret: adminSecret
        });

        if (result.status === 'success' && result.data) {
          const { available_keys = [], used_keys = [] } = result.data;
          renderKeysList(available_keys, used_keys);
          showStatus(`✅ Chaves carregadas: ${available_keys.length} disponíveis, ${used_keys.length} usadas`, 'success');
          addAuditEntry('SUCCESS', `Carregadas ${available_keys.length + used_keys.length} chaves`);
        } else {
          keysDisplay.innerHTML = '<div class="status-display error">❌ Erro ao carregar chaves</div>';
          showStatus('❌ Falha ao carregar chaves', 'error');
          addAuditEntry('ERROR', 'Falha no carregamento de chaves');
        }
      } catch (error) {
        keysDisplay.innerHTML = '<div class="status-display error">❌ Erro de conexão</div>';
        showStatus(`❌ ${error.message}`, 'error');
        addAuditEntry('ERROR', `Erro no carregamento: ${error.message}`);
      } finally {
        setLoading(btnViewKeys, false);
      }
    }

    function renderKeysList(availableKeys, usedKeys) {
      let html = `
        <div class="keys-section">
          <h3>🟢 Chaves Disponíveis (${availableKeys.length})</h3>
          <ul class="key-list">
      `;
      
      if (availableKeys.length > 0) {
        availableKeys.forEach(key => {
          html += `
            <li class="key-item">
              <span class="key-text" onclick="toggleKeyVisibility(this)">${sanitizeInput(key)}</span>
              <button class="copy-btn" onclick="copyToClipboard('${sanitizeInput(key)}', this)">
                📋
              </button>
            </li>
          `;
        });
      } else {
        html += `<li class="key-item">Nenhuma chave disponível</li>`;
      }
      
      html += `
          </ul>
        </div>
        <div class="keys-section" style="margin-top: 20px;">
          <h3>🔴 Chaves Usadas (${usedKeys.length})</h3>
          <ul class="key-list">
      `;
      
      if (usedKeys.length > 0) {
        usedKeys.forEach(key => {
          html += `
            <li class="key-item">
              <span class="key-text" onclick="toggleKeyVisibility(this)">${sanitizeInput(key)}</span>
              <button class="copy-btn" onclick="copyToClipboard('${sanitizeInput(key)}', this)">
                📋
              </button>
            </li>
          `;
        });
      } else {
        html += `<li class="key-item">Nenhuma chave usada</li>`;
      }
      
      html += `
          </ul>
        </div>
      `;
      
      keysDisplay.innerHTML = html;
    }

    function toggleKeyVisibility(element) {
      element.classList.toggle('revealed');
      const isRevealed = element.classList.contains('revealed');
      addAuditEntry('VIEW', `Chave ${isRevealed ? 'revelada' : 'ocultada'}`);
    }

    function copyToClipboard(text, button) {
      navigator.clipboard.writeText(text)
        .then(() => {
          const originalText = button.textContent;
          button.textContent = '✓';
          showToast('Chave copiada para a área de transferência', 'success');
          addAuditEntry('COPY', 'Chave copiada para clipboard');
          setTimeout(() => {
            button.textContent = originalText;
          }, 1500);
        })
        .catch(err => {
          console.error('Erro ao copiar:', err);
          showToast('Falha ao copiar texto', 'error');
          addAuditEntry('ERROR', 'Falha ao copiar chave');
        });
    }

    async function deleteKey() {
      const key = deleteKeyInput.value.trim();
      
      if (!validateInput(key, 'key')) {
        showStatus('❌ Formato de chave inválido', 'error');
        deleteKeyInput.focus();
        addAuditEntry('ERROR', 'Tentativa de excluir chave com formato inválido');
        return;
      }

      if (!deleteCaptchaToken) {
        showStatus('❌ Complete o reCAPTCHA para excluir chaves', 'error');
        return;
      }

      showConfirm(`Tem certeza que deseja excluir a chave "${sanitizeInput(key)}"?`, async () => {
        try {
          setLoading(btnDeleteKey, true);
          showStatus('⏳ Excluindo chave...');
          addAuditEntry('ACTION', `Excluindo chave específica`);

          const result = await makeRequest('admin_delete_key', {
            secret: adminSecret,
            key: key,
            recaptcha: deleteCaptchaToken
          });

          if (result.status === 'success') {
            showStatus(`✅ Chave "${sanitizeInput(key)}" excluída`, 'success');
            showToast('Chave excluída com sucesso', 'success');
            deleteKeyInput.value = '';
            addAuditEntry('SUCCESS', `Chave excluída: ${key.substring(0, 8)}...`);
            loadKeys();

            // Reset captcha after successful operation
            if (recaptchaWidgets.delete) {
              grecaptcha.enterprise.reset(recaptchaWidgets.delete);
              deleteCaptchaToken = null;
            }
          } else {
            showStatus(`❌ ${result.message || 'Chave não encontrada'}`, 'error');
            addAuditEntry('ERROR', `Falha na exclusão: ${result.message}`);
          }
        } catch (error) {
          showStatus(`❌ Falha: ${error.message}`, 'error');
          addAuditEntry('ERROR', `Erro na exclusão: ${error.message}`);
        } finally {
          setLoading(btnDeleteKey, false);
        }
      });
    }

    async function deleteAllKeys() {
      if (!deleteCaptchaToken) {
        showStatus('❌ Complete o reCAPTCHA para excluir chaves', 'error');
        return;
      }

      showConfirm('⚠️ ALERTA: Você está prestes a excluir TODAS as chaves. Esta ação é irreversível. Deseja continuar?', async () => {
        try {
          setLoading(btnDeleteAll, true);
          showStatus('⏳ Excluindo todas as chaves...');
          addAuditEntry('CRITICAL', 'Iniciando exclusão de todas as chaves');

          const result = await makeRequest('admin_delete_all_keys', {
            secret: adminSecret,
            recaptcha: deleteCaptchaToken
          });

          if (result.status === 'success') {
            showStatus('✅ Todas as chaves foram excluídas', 'success');
            showToast('Todas as chaves foram excluídas', 'success');
            addAuditEntry('CRITICAL', 'Todas as chaves foram excluídas');
            loadKeys();

            // Reset captcha after successful operation
            if (recaptchaWidgets.delete) {
              grecaptcha.enterprise.reset(recaptchaWidgets.delete);
              deleteCaptchaToken = null;
            }
          } else {
            showStatus(`❌ ${result.message || 'Erro ao excluir chaves'}`, 'error');
            addAuditEntry('ERROR', `Falha na exclusão em massa: ${result.message}`);
          }
        } catch (error) {
          showStatus(`❌ Falha: ${error.message}`, 'error');
          addAuditEntry('ERROR', `Erro na exclusão em massa: ${error.message}`);
        } finally {
          setLoading(btnDeleteAll, false);
        }
      });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      currentYear.textContent = new Date().getFullYear();
      applyTheme();
      updateSecurityStatus();
      addAuditEntry('SYSTEM', 'Painel administrativo iniciado');
      
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        handleLogin();
      });

      themeToggle.addEventListener('click', toggleTheme);
      btnLogout.addEventListener('click', handleLogout);
      btnGenerate.addEventListener('click', generateKeys);
      btnViewKeys.addEventListener('click', loadKeys);
      btnDeleteKey.addEventListener('click', deleteKey);
      btnDeleteAll.addEventListener('click', deleteAllKeys);
      confirmYes.addEventListener('click', () => {
        hideConfirm();
        if (currentConfirmCallback) currentConfirmCallback();
      });
      confirmNo.addEventListener('click', hideConfirm);

      setPanelEnabled(false);
      adminSecretInput.focus();

      // Security checks
      if (window.location.protocol !== 'https:') {
        showToast('⚠️ Esta página não está usando HTTPS. A segurança pode estar comprometida.', 'error');
        addAuditEntry('SECURITY', 'Conexão insegura detectada (HTTP)');
      }

      // Keyboard shortcuts for security
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'L') {
          e.preventDefault();
          if (adminSecret) {
            addAuditEntry('SECURITY', 'Logout via atalho de teclado');
            handleLogout();
          }
        }
      });
    });

    // Global functions for inline event handlers
    window.copyToClipboard = copyToClipboard;
    window.toggleKeyVisibility = toggleKeyVisibility;

    // reCAPTCHA callback
    window.recaptchaEnterpriseLoaded = function() {
      try {
        addAuditEntry('SYSTEM', 'reCAPTCHA Enterprise carregado');
        
        // Login reCAPTCHA
        recaptchaWidgets.login = grecaptcha.enterprise.render('loginCaptcha', {
          'sitekey': RECAPTCHA_SITE_KEY,
          'theme': document.body.classList.contains('light') ? 'light' : 'dark',
          'callback': function(token) {
            loginCaptchaToken = token;
            recaptchaError.style.display = 'none';
            addAuditEntry('SECURITY', 'reCAPTCHA de login validado');
          },
          'expired-callback': function() {
            loginCaptchaToken = null;
            addAuditEntry('SECURITY', 'reCAPTCHA de login expirado');
          }
        });

        // Generate Keys reCAPTCHA
        recaptchaWidgets.generate = grecaptcha.enterprise.render('generateCaptcha', {
          'sitekey': RECAPTCHA_SITE_KEY,
          'theme': document.body.classList.contains('light') ? 'light' : 'dark',
          'callback': function(token) {
            generateCaptchaToken = token;
            addAuditEntry('SECURITY', 'reCAPTCHA de geração validado');
          },
          'expired-callback': function() {
            generateCaptchaToken = null;
            addAuditEntry('SECURITY', 'reCAPTCHA de geração expirado');
          }
        });

        // Delete Keys reCAPTCHA
        recaptchaWidgets.delete = grecaptcha.enterprise.render('deleteCaptcha', {
          'sitekey': RECAPTCHA_SITE_KEY,
          'theme': document.body.classList.contains('light') ? 'light' : 'dark',
          'callback': function(token) {
            deleteCaptchaToken = token;
            addAuditEntry('SECURITY', 'reCAPTCHA de exclusão validado');
          },
          'expired-callback': function() {
            deleteCaptchaToken = null;
            addAuditEntry('SECURITY', 'reCAPTCHA de exclusão expirado');
          }
        });
      } catch (error) {
        console.error('Erro ao inicializar reCAPTCHA:', error);
        showToast('Erro ao carregar reCAPTCHA. Tente recarregar a página.', 'error');
        addAuditEntry('ERROR', 'Falha na inicialização do reCAPTCHA');
      }
    };
  </script>
</body>
</html>
